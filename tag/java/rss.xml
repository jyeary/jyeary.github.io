<?xml version="1.0" encoding="UTF-8" ?>

<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
<channel>
   
      <title>jyeary.github.io/</title>
   
   <link>http://0.0.0.0:4000</link>
   <description>A Caffeinated Java Developer.</description>
   <language>en-us</language>
   <managingEditor> </managingEditor>
   <atom:link href="rss" rel="self" type="application/rss+xml" />
   
	<item>
	  <title>Multiple Java Persistence API (JPA) persistence.xml Merging</title>
	  <link>//2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging</link>
	  <author></author>
	  <pubDate>2019-10-15T15:50:47+00:00</pubDate>
	  <guid>//2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging</guid>
	  <description><![CDATA[
	     <h2 id="introduction">Introduction</h2>

<p>Java Persistence API (JPA) is a great technology for combining the power of Java and data persistence. The specification goes a long way from the days of using EJB 1.0 for data management, but still comes with some limitations. One of them is using multiple jars that may contain <em>persistence.xml</em> files. The current limitation is that the first <em>persistence.xml</em> file that is found, is loaded by the <code class="highlighter-rouge">Classloader</code>, and the others are ignored.</p>

<p>The code below is used to get around this limitation by proxying the <code class="highlighter-rouge">Classloader</code>, scanning the jars for <em>persistence.xml</em> files and combining them into one file for the <code class="highlighter-rouge">Classloader</code> to load.</p>

<p>The original idea came from Fabrizio Giudici so I can not claim this as my own. The code below is based on his great work. My enhancements to his code are removal of duplicate classes that may be included in the multiple <em>persistence.xml</em> files, and the use of a Random Access Memory (RAM) file system to merge the files.</p>

<h1 id="code">Code</h1>

<p>The code will work on Java 8, but the changes in later versions of Java around class loading may prevent us from using this clever trick.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">bluelotussoftware</span><span class="o">.</span><span class="na">persistence</span><span class="o">;</span>
    
    <span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.io.StringWriter</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.text.MessageFormat</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Enumeration</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilder</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.Transformer</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerFactory</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.dom.DOMSource</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.stream.StreamResult</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPath</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathConstants</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpression</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpressionException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathFactory</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.FileObject</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.FileSystemException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.FileSystemManager</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.VFS</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.log4j.Logger</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.w3c.dom.Node</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.w3c.dom.NodeList</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
    
    <span class="cm">/**
     * @author Fabrizio Giudici
     * @author John Yeary &lt;jyeary@bluelotussoftware.com&gt;
     * @version 1.0.0
     */</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersistenceClassLoader</span> <span class="kd">extends</span> <span class="n">ClassLoader</span> <span class="o">{</span>
    
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">PersistenceClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DocumentBuilderFactory</span> <span class="n">DOCUMENT_BUILDER_FACTORY</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathFactory</span> <span class="n">XPATH_FACTORY</span> <span class="o">=</span> <span class="n">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPath</span> <span class="n">XPATH</span> <span class="o">=</span> <span class="n">XPATH_FACTORY</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathExpression</span> <span class="n">XPATH_ENTITY_PU_NODE</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathExpression</span> <span class="n">XPATH_PROPERTIES_NODE</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathExpression</span> <span class="n">XPATH_ENTITY_CLASS_TEXT</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PERSISTENCE_XML</span> <span class="o">=</span> <span class="s">"META-INF/persistence.xml"</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">URL</span> <span class="n">mergedPersistenceXml</span><span class="o">;</span>
    
        <span class="kd">static</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">XPATH_ENTITY_PU_NODE</span> <span class="o">=</span> <span class="n">XPATH</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//persistence/persistence-unit"</span><span class="o">);</span>
                <span class="n">XPATH_PROPERTIES_NODE</span> <span class="o">=</span> <span class="n">XPATH</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//persistence/persistence-unit/properties"</span><span class="o">);</span>
                <span class="n">XPATH_ENTITY_CLASS_TEXT</span> <span class="o">=</span> <span class="n">XPATH</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//persistence/persistence-unit/class/text()"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">XPathExpressionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * Constructor that wraps the provided {@link ClassLoader}
         *
         * @param parent The parent {@link ClassLoader} to wrap.
         */</span>
        <span class="kd">public</span> <span class="nf">PersistenceClassLoader</span><span class="o">(</span><span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * {@inheritDoc}
         * &lt;p&gt;
         * This handles setting the {@literal persistence.xml} from multiple {@literal META-INF/persistence.xml} files using
         * the same persistence unit.&lt;/p&gt;
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="nf">getResources</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">PERSISTENCE_XML</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mergedPersistenceXml</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">String</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">scanPersistenceXML</span><span class="o">();</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">merged</span><span class="o">);</span>
                        <span class="n">mergedPersistenceXml</span> <span class="o">=</span> <span class="n">getMergedURL</span><span class="o">(</span><span class="n">merged</span><span class="o">);</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">MessageFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Merged persistence.xml URL: {0}"</span><span class="o">,</span> <span class="n">mergedPersistenceXml</span><span class="o">));</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">ParserConfigurationException</span> <span class="o">|</span> <span class="n">SAXException</span> <span class="o">|</span> <span class="n">XPathExpressionException</span> <span class="o">|</span> <span class="n">TransformerException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">//TODO Need to return the first persistence.xml file, or throw a new exception. This should be fatal.</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">fatal</span><span class="o">(</span><span class="s">"Could not merge persistence.xml files"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">parent</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">mergedPersistenceXml</span><span class="o">;</span>
    
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasMoreElements</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">url</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
    
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="n">URL</span> <span class="nf">nextElement</span><span class="o">()</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="n">URL</span> <span class="n">url2</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">return</span> <span class="n">url2</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">};</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * Scans the {@link ClassLoader#getResources(java.lang.String)} for {@literal persistence.xml} files.
         *
         * @return A {@code Collection&lt;URL} of {@literal persistence.xml} URLs.
         * @throws IOException If an exception occurs during processing.
         */</span>
        <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="nf">findPersistenceXMLs</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">PERSISTENCE_XML</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * Converts a {@link Document} to a {@code String}.
         *
         * @param document The document to convert.
         * @return A {@code String} representation of the document if the conversion was successful, and {@literal null}
         * otherwise.
         */</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="nf">documentToString</span><span class="o">(</span><span class="kd">final</span> <span class="n">Document</span> <span class="n">document</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">DOMSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DOMSource</span><span class="o">(</span><span class="n">document</span><span class="o">);</span>
                <span class="n">StringWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
                <span class="n">StreamResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamResult</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
                <span class="n">TransformerFactory</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">TransformerFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
                <span class="n">Transformer</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">();</span>
                <span class="n">transformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransformerException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not convert Document to String"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * This method creates the merged {@literal persistence.xml} file from all of {@literal persistence.xml} files found
         * by the {@link ClassLoader} during its scan and constructs a {@link Document} containing the merged
         * {@literal &lt;class&gt;} elements.
         *
         * @return A {@code String} representation of the {@link Document} that was generated.
         */</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="nf">scanPersistenceXML</span><span class="o">()</span>
                <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
                <span class="n">ParserConfigurationException</span><span class="o">,</span>
                <span class="n">SAXException</span><span class="o">,</span>
                <span class="n">XPathExpressionException</span><span class="o">,</span>
                <span class="n">TransformerConfigurationException</span><span class="o">,</span>
                <span class="n">TransformerException</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"scanPersistenceXML()"</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DOCUMENT_BUILDER_FACTORY</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
            <span class="n">DOCUMENT_BUILDER_FACTORY</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">persistenceXMlUrls</span> <span class="o">=</span> <span class="n">findPersistenceXMLs</span><span class="o">();</span>
    
            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">persistenceXMlUrls</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="kd">final</span> <span class="n">URL</span> <span class="n">masterURL</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;&gt; master persistence.xml: %s"</span><span class="o">,</span> <span class="n">masterURL</span><span class="o">));</span>
            <span class="kd">final</span> <span class="n">Document</span> <span class="n">masterDocument</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">masterURL</span><span class="o">.</span><span class="na">toExternalForm</span><span class="o">());</span>
            <span class="kd">final</span> <span class="n">Node</span> <span class="n">puNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">)</span> <span class="n">XPATH_ENTITY_PU_NODE</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODE</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">Node</span> <span class="n">propertiesNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">)</span> <span class="n">XPATH_PROPERTIES_NODE</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODE</span><span class="o">);</span>
    
            <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">URL</span> <span class="n">url</span> <span class="o">:</span> <span class="n">persistenceXMlUrls</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;&gt; other persistence.xml: %s"</span><span class="o">,</span> <span class="n">url</span><span class="o">));</span>
                <span class="kd">final</span> <span class="n">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">toExternalForm</span><span class="o">());</span>
                <span class="kd">final</span> <span class="n">NodeList</span> <span class="n">nodes</span> <span class="o">=</span> <span class="o">(</span><span class="n">NodeList</span><span class="o">)</span> <span class="n">XPATH_ENTITY_CLASS_TEXT</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">document</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
    
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">String</span> <span class="n">entityClassName</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getNodeValue</span><span class="o">();</span>
    
                    <span class="cm">/*
                     * Check for duplicates and only add new classes.
                     */</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">classNodeExists</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">entityClassName</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; entity class: %s found. Adding to persistence.xml"</span><span class="o">,</span> <span class="n">entityClassName</span><span class="o">));</span>
    
                        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createComment</span><span class="o">(</span><span class="s">" from "</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toExternalForm</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span><span class="o">),</span> <span class="n">propertiesNode</span><span class="o">);</span>
                            <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createTextNode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">),</span> <span class="n">propertiesNode</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="kd">final</span> <span class="n">Node</span> <span class="n">child</span> <span class="o">=</span> <span class="n">masterDocument</span><span class="o">.</span><span class="na">createElement</span><span class="o">(</span><span class="s">"class"</span><span class="o">);</span>
                        <span class="n">child</span><span class="o">.</span><span class="na">appendChild</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createTextNode</span><span class="o">(</span><span class="n">entityClassName</span><span class="o">));</span>
                        <span class="c1">// The entity classes must be appended before the properties to successfully validate.</span>
                        <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">propertiesNode</span><span class="o">);</span>
                        <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createTextNode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">),</span> <span class="n">propertiesNode</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
    
            <span class="k">return</span> <span class="nf">documentToString</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * &lt;p&gt;
         * This method will provide a {@link URL} to a virtual file stored in Random Access Memory (RAM) using
         * {@link FileSystemManager}.The method is sufficiently abstract to store any {@code String} data.&lt;/p&gt;
         * &lt;p&gt;
         * The implementation in this class will be used to store our merged persistence.xml files. This way we can avoid
         * storing the merged file on the operating system.&lt;/p&gt;
         *
         * @param data The data to be stored to a virtual file in RAM.
         * @return The {@link URL} to the virtual file in RAM.
         */</span>
        <span class="kd">private</span> <span class="n">URL</span> <span class="nf">getMergedURL</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">FileSystemManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">VFS</span><span class="o">.</span><span class="na">getManager</span><span class="o">();</span>
                <span class="c1">// The EntityManagerFactory will scan a pattern like PROJECT_NAME/META-INF/ for persistence.xml file.</span>
                <span class="n">FileObject</span> <span class="n">pxml</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">resolveFile</span><span class="o">(</span><span class="s">"ram://RAM_MERGED_PERSISTENCE/META-INF/persistence.xml"</span><span class="o">);</span>
                <span class="n">pxml</span><span class="o">.</span><span class="na">createFile</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">(</span><span class="n">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">pxml</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">getOutputStream</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">IOUtils</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">os</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">pxml</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)));</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">pxml</span><span class="o">.</span><span class="na">getURL</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileSystemException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not create RAM filesystem."</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"An exception occurred while trying to generate merged URL"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * This checks the provided master {@literal persistence.xml} {@link Document} for the existence of a class node.
         *
         * @param masterDocument The document to evaluate.
         * @param className The name of class to check to see if it already exists.
         * @return {@literal true} if the class already exists and {@literal false} otherwise.
         */</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">classNodeExists</span><span class="o">(</span><span class="n">Document</span> <span class="n">masterDocument</span><span class="o">,</span> <span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="kd">final</span> <span class="n">NodeList</span> <span class="n">nodeList</span><span class="o">;</span>
    
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">nodeList</span> <span class="o">=</span> <span class="o">(</span><span class="n">NodeList</span><span class="o">)</span> <span class="n">XPATH_ENTITY_CLASS_TEXT</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">XPathExpressionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"The provided persistence.xml contains no class entries"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
    
            <span class="n">String</span> <span class="n">masterEntityClassName</span><span class="o">;</span>
    
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">masterEntityClassName</span> <span class="o">=</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">j</span><span class="o">).</span><span class="na">getNodeValue</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">masterEntityClassName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    
    <span class="o">}</span>
</code></pre></div></div>

<p>The implementation is simply a matter of doing a switch on the <code class="highlighter-rouge">ClassLoader</code> as shown below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    
            <span class="n">ClassLoader</span> <span class="n">contextClassLoader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
            <span class="n">PersistenceClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PersistenceClassLoader</span><span class="o">(</span><span class="n">contextClassLoader</span><span class="o">);</span>
    
            <span class="c1">// We must set the Classloader to use our loader BEFORE calling Persistence.Persistence.createEntityManagerFactory()</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
    
            <span class="n">EntityManagerFactory</span> <span class="n">entityManagerFactory</span> <span class="o">=</span> <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"emample-pu"</span><span class="o">);</span>
    
            <span class="c1">//Reset the classloader</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">contextClassLoader</span><span class="o">);</span>
    
            <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
    
            <span class="o">...</span>
        <span class="o">}</span>
</code></pre></div></div>
<h1 id="conclusion">Conclusion</h1>

<p>The Java Persistence API (JPA) is a great technology, but has some limitations with regards to loading multiple <em>persistence.xml</em> files. We can use <code class="highlighter-rouge">Classloader</code> magic to accomplish loading multiple <em>persistence.xml</em> files.</p>

<p>This code may not work as expected on later versions of Java. At the time of this writing, Java 8 is still used by most of the enterprise clients I work with.</p>

	  ]]></description>
	</item>


</channel>
</rss>
