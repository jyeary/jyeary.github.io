<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Mercurial on IIS</title>
    <meta name="description" content="A Caffeinated Java Developer." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/custom.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="https://johnyeary.com//2018-06-29-mercurial-on-iis.html" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="John Yeary" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Mercurial on IIS" />
    <meta property="og:description" content="A Caffeinated Java Developer." />
    <meta property="og:url" content="https://johnyeary.com//2018-06-29-mercurial-on-iis.html" />
    <meta property="og:image" content="/assets/images/photo-of-white-eggs-on-tray-4110226.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Mercurial on IIS" />
    <meta name="twitter:description" content="A Caffeinated Java Developer." />
    <meta name="twitter:url" content="https://johnyeary.com//2018-06-29-mercurial-on-iis.html" />
    <meta name="twitter:image:src" content="/assets/images/photo-of-white-eggs-on-tray-4110226.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "John Yeary",
    "name": "Mercurial on IIS",
    "url": "https://johnyeary.com//2018-06-29-mercurial-on-iis.html",
    "image": "/assets/images/photo-of-white-eggs-on-tray-4110226.jpg",
    "description": "A Caffeinated Java Developer."
}
    </script>

    <meta name="generator" content="Jekyll 4.0.0" />
    <link rel="alternate" type="application/rss+xml" title="John Yeary" href="/feed.xml" />

    <!-- Add Google Analytics  -->
         <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-4194623-5', 'auto');
	    ga('send', 'pageview');
     </script>

</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!--
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        -->
        <li class="nav-java " role="presentation"><a href="/tag/java">Java</a></li>
        <li class="nav-life " role="presentation"><a href="/tag/life">Life</a></li>
        <li class="nav-mac " role="presentation"><a href="/tag/mac">Mac</a></li>
        <li class="nav-merchant-marine " role="presentation"><a href="/tag/merchant-marine">Merchant Marine</a></li>
        <li class="nav-military " role="presentation"><a href="/tag/military">Military</a></li>
        <li class="nav-national-security " role="presentation"><a href="/tag/national-security">National Security</a></li>
        <li class="nav-unix " role="presentation"><a href="/tag/unix">UNIX</a></li>
        <li class="nav-web " role="presentation"><a href="/tag/web">Web</a></li>
        <li class="nav-yoga " role="presentation"><a href="/tag/yoga">Yoga</a></li>
        <li class="nav-author " role="presentation"><a href="/author/jyeary">John Yeary</a></li>
        <!--
        <li class="nav-speeches " role="presentation"><a href="/tag/speeches">Speeches</a></li>
        <li class="nav-fiction " role="presentation"><a href="/tag/fiction">Fiction</a></li>
        <li class="nav-author " role="presentation"><a href="/author/casper">Casper</a></li>
        <li class="nav-author " role="presentation"><a href="/author/edgar">Edgar</a></li>
        <li class="nav-author " role="presentation"><a href="/author/abraham">Abraham</a></li>
        <li class="nav-author " role="presentation"><a href="/author/martin">Martin</a></li>
        <li class="nav-author " role="presentation"><a href="/author/lewis">Lewis</a></li>
        -->
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/photo-of-white-eggs-on-tray-4110226.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/logo.jpg" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-web">

        <header class="post-header">
            <h1 class="post-title">Mercurial on IIS</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href='/author/jyeary'>John Yeary</a>
                
            
            <time class="post-date" datetime="2018-06-29">29 Jun 2018</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/web'>Web</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <h3 id="introduction">Introduction</h3>
<p>I was recently tasked with updating our Mercurial repository at work. The original repository and configuration using Apache had been in place for years without issues generally. The latest Apache versions for Windows are provided by third parties and not from Apache Foundation anymore.</p>

<p>When I looked at the configuration we were using, the Python FastCGI modules were very old and had not been updated in years. In fairness, they didn’t need to be for our application, but there were no updates for the latest Apache HTTPD server. The existing third party versions of Apache didn’t include the required libraries for the old modules. I didn’t want to install everything required to compile a new version of Apache for our environment. This would add application maintenance overhead to me to maintain and update it. So what were my alternatives?</p>

<p>Since the application was already running on a Windows server, I decided to see if I could implement it on Windows without having to migrate to a Linux server. Although migrating to Linux, or UNIX would have been my preference, it was not available to me. The solution was to try to use IIS to serve up the application. Specifically, I had a set of requirements:</p>
<ol>
  <li>Windows AD authentication.</li>
  <li>Mercurial needed to be available via HTTPS.</li>
  <li>Latest version of Mercurial</li>
  <li>Simple implementation</li>
  <li>Easy maintenance</li>
</ol>

<p>The ease of maintenance would be normal Windows server updates. The implementation should be sufficiently simple that a new ops, or engineer could be assigned the task of updating it, or maintaining it.</p>

<p>Since Mercurial is popular, I thought finding some details on deploying Mercurial on IIS would be simple. I found some blog posts and wiki pages on it, but they were very old. Nothing was up-to-date. So I decided to write my own post with details I gathered from multiple blog posts and references.</p>

<h3 id="python">Python</h3>
<p>Install Python. I installed the <strong>python-2.7.15.amd64.msi</strong> on the server accepting the defaults except I also added Python to the path as shown below.</p>

<p><img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/PythonInstall.png" alt="Python Install" /></p>

<h3 id="mercurial">Mercurial</h3>
<p>Install Mercurial. I installed <strong>mercurial-4.6.1.win-amd64-py2.7.msi</strong> which will install it into the Python installation.</p>

<p>Once the installation is complete open a command prompt or Powershell and type <em>hg</em>. It should display a list of commands available.</p>

<h3 id="iis">IIS</h3>
<p>Install/activate IIS. We need to insure that CGI is enabled for wfastcgi.</p>
<ol>
  <li>Open <strong>Server Manager</strong></li>
  <li>Go to <strong>Add Roles and Features</strong>. Scroll down and select <strong>Web Server (IIS)</strong> and <strong>Next</strong>. Continue <strong>Next</strong> until you reach <em>Role Services</em>. 
  <img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/AddRemoveIIS.png" alt="Add Remove IIS" /></li>
  <li>(OPTIONAL) Under <strong>Performance</strong>, select <em>Dynamic Content Compression</em>.</li>
  <li>(OPTIONAL) Under <strong>Security</strong>, select any mechanism you want to use to allow users to connect. I selected <em>Basic Authentication</em> and <em>Windows Authentication</em>. Click <strong>Next</strong>.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/RoleSevices.png" alt="Roles Services" /></li>
  <li>Check options and click <strong>Install</strong>.</li>
  <li>Once the install completes, we need to go back to <strong>Add Roles and Features</strong>. This time navigate to <em>Application Development</em> and select <em>CGI</em>.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/CGIEnabled.png" alt="CGI Enabled" /></li>
</ol>

<h3 id="python-fastcgi-implementation-wfastcgi">Python FastCGI implementation (wfastcgi)</h3>
<p>I looked for an implementation that would provide the sufficient capabilities to serve up the pages quickly with little overhead. I looked at a number of implementations. I was looking at wfastcgi and noticed that it was created and maintained by Microsoft. Bonus!</p>

<ol>
  <li>Using a command prompt or Powershell. type the following:
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip install wfastcgi
</code></pre></div>    </div>
  </li>
  <li>Once <em>pip</em> finshes installing <em>wfastcgi</em>, run the following command to enable <em>wfastcgi</em>.
    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wfastcgi-enable     
</code></pre></div>    </div>
    <p><img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/pipInstall.png" alt="pip install" /></p>
  </li>
  <li>After enabling <em>wfastcgi</em>, we can refresh our IIS Application Server Manager instance and we will have a new IIS management category called <strong>FastCGI Settings</strong>. Just confirm its presence we will attend to it shortly.</li>
  <li>Next go to Sites in IIS Admin and ensure that you have the <em>Default Website</em> stopped.</li>
  <li>Right-click and <strong>Add Website</strong>. This will bring up a form to configure. I set my settings as shown below. You may change them to meet your needs.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/AddWebsite.png" alt="Add Website" /></li>
  <li>Set the website bindings as shown below:
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/SiteBindings.png" alt="Site Bindings" /></li>
</ol>

<h3 id="final-configuration">Final Configuration</h3>
<ol>
  <li>Copy the <strong>C:\Python27\Lib\site-packages\wfastcgi.py</strong> to the root directory of your new site. In my case it is the <em>C:\inetpub\hg</em> directory.</li>
  <li>Place the following script in the root directory and name it <strong>hgweb.py</strong>:
    <div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span> = <span class="s2">"hgweb.config"</span>
<span class="n">from</span> <span class="n">mercurial</span> <span class="n">import</span> <span class="n">demandimport</span>; <span class="n">demandimport</span>.<span class="n">enable</span>()
<span class="n">from</span> <span class="n">mercurial</span>.<span class="n">hgweb</span> <span class="n">import</span> <span class="n">hgweb</span>
<span class="n">application</span> = <span class="n">hgweb</span>(<span class="n">config</span>)
</code></pre></div>    </div>
  </li>
  <li>Create a <strong>hgweb.config</strong> file and place it in the root directory. If you use the script below, please make sure you have a path to your repositories set. You can use the instructions available in Mercurial to reconfigure it later. Here is an example:
    <div class="language-conf highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[<span class="n">web</span>]
<span class="n">encoding</span> = <span class="n">UTF</span>-<span class="m">8</span>
<span class="n">allow_push</span> = *
<span class="n">push_ssl</span> = <span class="n">False</span>
<span class="n">allow_archive</span> = <span class="n">gz</span> <span class="n">zip</span> <span class="n">bz2</span>
<span class="n">descend</span> = <span class="n">True</span>
<span class="n">collapse</span> = <span class="n">True</span>
<span class="n">style</span>=<span class="n">gitweb</span>
[<span class="n">paths</span>]
/ = <span class="n">C</span>:\<span class="n">repos</span>\*
</code></pre></div>    </div>
    <p><strong>NOTE:</strong> This method of listing repositories can be very slow if there are a number of repositories. It is better to list them individually.</p>
  </li>
  <li>Go to the IIS Admin <strong>Sites</strong> and select your Mercurial site. Go to <strong>Handler Mappings</strong>.</li>
  <li>Click <strong>Add Module Mapping</strong> and provide the following details:
    <ul>
      <li><strong>Request Path:</strong> *</li>
      <li><strong>Module:</strong> FastCgiModule</li>
      <li><strong>Executable:</strong> C:\Python27\python.exe|C:\inetpub\hg\wfastcgi.py
<strong>WARNING:</strong> There can not be any spaces between the values and the pipe (|) character otherwise it won’t work and you will be hating life trying to figure out why its not working.</li>
      <li><strong>Name:</strong> hg-wfastcgi
Continue to the next step below.</li>
    </ul>
  </li>
  <li>Click on <em>Request Restrictions</em> button.
    <ul>
      <li><strong>Mapping</strong> » Uncheck checkbox <strong>Invoke handler only if request mapped to</strong>.</li>
      <li><strong>Verbs:</strong> » <em>All Verbs</em> radio button selected.</li>
      <li><strong>Access:</strong> » <em>Script</em>  radio button selected.
Click OK.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/HandlerMapping.png" alt="Handler Mapping" /></li>
    </ul>
  </li>
  <li>Click OK. This will prompt you to create an application to handle the requests. <strong>Important</strong> Click *Yes**.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/CreateApplicationHandler.png" alt="Create Application Handler" /></li>
  <li>Configuring <em>wfastcgi</em> to respond to Mercurial requests. Go to the IIS Admin <em>FastCGI Settings</em> page.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/FastCGISettings01.png" alt="FastCGI Settings Default" /></li>
  <li>You should see the newly created handler at the bottom of the list. Click <strong>Edit</strong> which will bring up the form window. If it doesn’t exist, then you will need to <strong>Add Application</strong>. Fill in the following:
    <ul>
      <li><strong>Full Path:</strong> <em>C:\Python27\python.exe</em> (Only required if adding application)</li>
      <li><strong>Arguments:</strong> <em>C:\inetpub\hg\wfastcgi.py</em> (Only required if adding application)</li>
      <li><strong>General » Max Instances:</strong> 10</li>
      <li><strong>Process Model » Activity Timeout:</strong> 300</li>
      <li><strong>Process Model » Idle Timeout:</strong> 600</li>
      <li><strong>Process Model » Request Timeout:</strong> 600</li>
      <li><strong>General » Environment Variables:</strong> You will be adding the following environment variables:</li>
      <li><strong>Name:</strong> <em>PYTHONPATH</em> <strong>Value:</strong> <em>C:\inetpub\hg</em></li>
      <li><strong>Name:</strong> <em>WSGI_HANDLER</em> <strong>Value:</strong> <em>hgweb.application</em><br />
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/FastCGISettings02.png" alt="FastCGI Settings Updated" />
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/PYTHONPATH.png" alt="PYTHONPATH Environment Setting" />
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/WSGI_HANDLER.png" alt="WSGI_HANDLER Environment Setting" /></li>
    </ul>
  </li>
  <li>Restart the web server and you should be in business. Open a browser and go to the address of the machine and you should see any repositories that are listed in your <strong>hgweb.config</strong> file.
<img src="https://storage.googleapis.com/methodical-kaleidoscope-7367/2018/06/Success.png" alt="Mercurial on IIS" /></li>
</ol>

<h3 id="security">Security</h3>
<p>The application is not configured with authentication at this point. If you decide to use AD, you will need to configure IIS for the site to use AD. If you choose to use authentication, don’t forget to modify the <strong>hgweb.config</strong> file to <em>allow_push</em> for the users that should be allowed to push changes to the repository.</p>

<h3 id="references">References</h3>
<ul>
  <li><a href="http://nick.txtcc.com/index.php/other/910">Setting up a Mercurial server under IIS7 on Windows Server 2008 R2</a></li>
  <li><a href="http://blog.vishalon.net/running-mercurial-2-x-web-server-on-iis-7-5">Running Mercurial 2.x Web server on IIS 7.5</a></li>
  <li><a href="http://www.jeremyskinner.co.uk/mercurial-on-iis7/">Setting up a Mercurial server under IIS7 on Windows Server 2008 R2</a></li>
  <li><a href="https://pypi.org/project/wfastcgi/">wfastcgi 3.0.0</a></li>
  <li><a href="https://medium.com/@bilalbayasut/deploying-python-web-app-flask-in-windows-server-iis-using-fastcgi-6c1873ae0ad8">Deploying Python web app (Flask) in Windows Server (IIS) using FastCGI</a></li>
  <li><a href="https://www.mercurial-scm.org/wiki/PublishingRepositories#hgweb">3.2. Getting the hgweb script</a></li>
  <li><a href="https://gist.github.com/bparaj/ac8dd5c35a15a7633a268e668f4d2c94">Python Flask on IIS with wfastcgi</a></li>
</ul>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/jyeary" style="background-image: url(/assets/images/jyeary.jpg)"><span class="hidden">jyeary's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/jyeary">John Yeary</a></h4>

                        
                            <p> Caffeinated Java Programmer, and Principal Software Engineer at Orange Bees. My opinions are my own.</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Greenville, South Carolina, USA</span>
                            <span class="author-link icon-link"><a href="https://johnyeary.com/author/jyeary/"> johnyeary.com</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="https://twitter.com/share?text=Mercurial on IIS&amp;url=https://johnyeary.com/2018-06-29-mercurial-on-iis.html"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://johnyeary.com/2018-06-29-mercurial-on-iis.html"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <!--
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=https://johnyeary.com2018-06-29-mercurial-on-iis.html"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                        -->
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'john-yeary'; // required: replace example with your forum shortname
    var disqus_identifier = '/2018-06-29-mercurial-on-iis.html';
    var disqus_url = 'https://johnyeary.com/2018-06-29-mercurial-on-iis.html';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/pexels-photo-1093645.jpg)" href="/2018-07-04-patriotism.html">
            <section class="post">
                <h2>Patriotism</h2>
                <p>### Independence Day... I think most Americans will celebrate with food, fireworks, and perhaps some...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/pexels-photo-209137.jpeg)" href="/2018-06-29-apache-commons-io-directory-copying.html">
            <section class="post">
                <h2>Apache Commons IO Directory Copying</h2>
                <p>Introduction I was having an issue with some code in a very large project, and...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">John Yeary</a> &copy; 2020</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
