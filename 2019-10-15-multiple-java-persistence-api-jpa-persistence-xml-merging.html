<!DOCTYPE html>
<html>
<head>
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Page Meta -->
    <title>Multiple Java Persistence API (JPA) persistence.xml Merging</title>
    <meta name="description" content="A Caffeinated Java Developer." />

    <!-- Mobile Meta -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Brand icon -->
    <link rel="shortcut icon" href="/assets/images/favicon.ico" >

    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/css/screen.css" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
    <link rel="stylesheet" type="text/css" href="/assets/css/syntax.css" />

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- Ghost outputs important style and meta data with this tag -->
        <link rel="canonical" href="//2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging" />
    <meta name="referrer" content="origin" />
    <link rel="next" href="/page2/" />

    <meta property="og:site_name" content="John Yeary" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Multiple Java Persistence API (JPA) persistence.xml Merging" />
    <meta property="og:description" content="A Caffeinated Java Developer." />
    <meta property="og:url" content="//2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging" />
    <meta property="og:image" content="/assets/images/boats-canoes-daytime-2907206.jpg" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Multiple Java Persistence API (JPA) persistence.xml Merging" />
    <meta name="twitter:description" content="A Caffeinated Java Developer." />
    <meta name="twitter:url" content="//2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging" />
    <meta name="twitter:image:src" content="/assets/images/boats-canoes-daytime-2907206.jpg" />

    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Website",
    "publisher": "John Yeary",
    "name": "Multiple Java Persistence API (JPA) persistence.xml Merging",
    "url": "//2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging",
    "image": "/assets/images/boats-canoes-daytime-2907206.jpg",
    "description": "A Caffeinated Java Developer."
}
    </script>

    <meta name="generator" content="Jekyll 3.0.0" />
    <link rel="alternate" type="application/rss+xml" title="John Yeary" href="/feed.xml" />


</head>
<body class="home-template nav-closed">

    <!-- The blog navigation links -->
    <div class="nav">
    <h3 class="nav-title">Menu</h3>
    <a href="#" class="nav-close">
        <span class="hidden">Close</span>
    </a>
    <ul>
        <li class="nav-home " role="presentation"><a href="/">Home</a></li>
        <!--
        <li class="nav-about " role="presentation"><a href="/about">About</a></li>
        -->
        <li class="nav-java  nav-current" role="presentation"><a href="/tag/java">Java</a></li>
        <li class="nav-web " role="presentation"><a href="/tag/web">Web</a></li>
        <li class="nav-author " role="presentation"><a href="/author/jyeary">John Yeary</a></li>
        <!--
        <li class="nav-speeches " role="presentation"><a href="/tag/speeches">Speeches</a></li>
        <li class="nav-fiction " role="presentation"><a href="/tag/fiction">Fiction</a></li>
        <li class="nav-author " role="presentation"><a href="/author/casper">Casper</a></li>
        <li class="nav-author " role="presentation"><a href="/author/edgar">Edgar</a></li>
        <li class="nav-author " role="presentation"><a href="/author/abraham">Abraham</a></li>
        <li class="nav-author " role="presentation"><a href="/author/martin">Martin</a></li>
        <li class="nav-author " role="presentation"><a href="/author/lewis">Lewis</a></li>
        -->
    </ul>
    <a class="subscribe-button icon-feed" href="/feed.xml">Subscribe</a>
</div>
<span class="nav-cover"></span>


    <div class="site-wrapper">

        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The comment above "< default" means - insert everything in this file into -->
    <!-- the [body] of the default.hbs template, which contains our header/footer. -->

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<header class="main-header post-head " style="background-image: url(/assets/images/boats-canoes-daytime-2907206.jpg) ">
    <nav class="main-nav  overlay  clearfix">
        <a class="blog-logo" href="/"><img src="/assets/images/logo.jpg" alt="Blog Logo" /></a>
        
            <a class="menu-button icon-menu" href="#"><span class="word">Menu</span></a>
        
    </nav>
</header>

<main class="content" role="main">

    <article class="post tag-java">

        <header class="post-header">
            <h1 class="post-title">Multiple Java Persistence API (JPA) persistence.xml Merging</h1>
            <section class="post-meta">
            <!-- <a href='/'></a> -->

            
                
                    <a href='/author/jyeary'>John Yeary</a>
                
            
            <time class="post-date" datetime="2019-10-15">15 Oct 2019</time>
                <!-- [[tags prefix=" on "]] -->
                
                on
                
                    
                       <a href='/tag/java'>Java</a>
                    
                
                
            </section>
        </header>

        <section class="post-content">

            <h2 id="introduction">Introduction</h2>

<p>Java Persistence API (JPA) is a great technology for combining the power of Java and data persistence. The specification goes a long way from the days of using EJB 1.0 for data management, but still comes with some limitations. One of them is using multiple jars that may contain <em>persistence.xml</em> files. The current limitation is that the first <em>persistence.xml</em> file that is found, is loaded by the <code class="highlighter-rouge">Classloader</code>, and the others are ignored.</p>

<p>The code below is used to get around this limitation by proxying the <code class="highlighter-rouge">Classloader</code>, scanning the jars for <em>persistence.xml</em> files and combining them into one file for the <code class="highlighter-rouge">Classloader</code> to load.</p>

<p>The original idea came from Fabrizio Giudici so I can not claim this as my own. The code below is based on his great work. My enhancements to his code are removal of duplicate classes that may be included in the multiple <em>persistence.xml</em> files, and the use of a Random Access Memory (RAM) file system to merge the files.</p>

<h1 id="code">Code</h1>

<p>The code will work on Java 8, but the changes in later versions of Java around class loading may prevent us from using this clever trick.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">bluelotussoftware</span><span class="o">.</span><span class="na">persistence</span><span class="o">;</span>
    
    <span class="kn">import</span> <span class="nn">java.io.IOException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.io.OutputStream</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.io.StringWriter</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.net.URL</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.nio.charset.Charset</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.text.MessageFormat</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Collection</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Enumeration</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">java.util.Iterator</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilder</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.parsers.DocumentBuilderFactory</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.parsers.ParserConfigurationException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.Transformer</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerConfigurationException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.TransformerFactory</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.dom.DOMSource</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.transform.stream.StreamResult</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPath</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathConstants</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpression</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathExpressionException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">javax.xml.xpath.XPathFactory</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.io.IOUtils</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.FileObject</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.FileSystemException</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.FileSystemManager</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.commons.vfs2.VFS</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.apache.log4j.Logger</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.w3c.dom.Document</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.w3c.dom.Node</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.w3c.dom.NodeList</span><span class="o">;</span>
    <span class="kn">import</span> <span class="nn">org.xml.sax.SAXException</span><span class="o">;</span>
    
    <span class="cm">/**
     * @author Fabrizio Giudici
     * @author John Yeary &lt;jyeary@bluelotussoftware.com&gt;
     * @version 1.0.0
     */</span>
    <span class="kd">public</span> <span class="kd">class</span> <span class="nc">PersistenceClassLoader</span> <span class="kd">extends</span> <span class="n">ClassLoader</span> <span class="o">{</span>
    
        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">LOGGER</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">PersistenceClassLoader</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">DocumentBuilderFactory</span> <span class="n">DOCUMENT_BUILDER_FACTORY</span> <span class="o">=</span> <span class="n">DocumentBuilderFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathFactory</span> <span class="n">XPATH_FACTORY</span> <span class="o">=</span> <span class="n">XPathFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPath</span> <span class="n">XPATH</span> <span class="o">=</span> <span class="n">XPATH_FACTORY</span><span class="o">.</span><span class="na">newXPath</span><span class="o">();</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathExpression</span> <span class="n">XPATH_ENTITY_PU_NODE</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathExpression</span> <span class="n">XPATH_PROPERTIES_NODE</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">XPathExpression</span> <span class="n">XPATH_ENTITY_CLASS_TEXT</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">PERSISTENCE_XML</span> <span class="o">=</span> <span class="s">"META-INF/persistence.xml"</span><span class="o">;</span>
        <span class="kd">private</span> <span class="n">URL</span> <span class="n">mergedPersistenceXml</span><span class="o">;</span>
    
        <span class="kd">static</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">XPATH_ENTITY_PU_NODE</span> <span class="o">=</span> <span class="n">XPATH</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//persistence/persistence-unit"</span><span class="o">);</span>
                <span class="n">XPATH_PROPERTIES_NODE</span> <span class="o">=</span> <span class="n">XPATH</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//persistence/persistence-unit/properties"</span><span class="o">);</span>
                <span class="n">XPATH_ENTITY_CLASS_TEXT</span> <span class="o">=</span> <span class="n">XPATH</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">"//persistence/persistence-unit/class/text()"</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">XPathExpressionException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">ExceptionInInitializerError</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * Constructor that wraps the provided {@link ClassLoader}
         *
         * @param parent The parent {@link ClassLoader} to wrap.
         */</span>
        <span class="kd">public</span> <span class="nf">PersistenceClassLoader</span><span class="o">(</span><span class="kd">final</span> <span class="n">ClassLoader</span> <span class="n">parent</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="n">parent</span><span class="o">);</span>
            <span class="k">this</span><span class="o">.</span><span class="na">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">;</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * {@inheritDoc}
         * &lt;p&gt;
         * This handles setting the {@literal persistence.xml} from multiple {@literal META-INF/persistence.xml} files using
         * the same persistence unit.&lt;/p&gt;
         */</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="nf">getResources</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">PERSISTENCE_XML</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mergedPersistenceXml</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">String</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">scanPersistenceXML</span><span class="o">();</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">merged</span><span class="o">);</span>
                        <span class="n">mergedPersistenceXml</span> <span class="o">=</span> <span class="n">getMergedURL</span><span class="o">(</span><span class="n">merged</span><span class="o">);</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">MessageFormat</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"Merged persistence.xml URL: {0}"</span><span class="o">,</span> <span class="n">mergedPersistenceXml</span><span class="o">));</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="o">|</span> <span class="n">ParserConfigurationException</span> <span class="o">|</span> <span class="n">SAXException</span> <span class="o">|</span> <span class="n">XPathExpressionException</span> <span class="o">|</span> <span class="n">TransformerException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">//TODO Need to return the first persistence.xml file, or throw a new exception. This should be fatal.</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">fatal</span><span class="o">(</span><span class="s">"Could not merge persistence.xml files"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                        <span class="k">return</span> <span class="n">parent</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="k">new</span> <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;()</span> <span class="o">{</span>
                    <span class="n">URL</span> <span class="n">url</span> <span class="o">=</span> <span class="n">mergedPersistenceXml</span><span class="o">;</span>
    
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">hasMoreElements</span><span class="o">()</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">url</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
    
                    <span class="nd">@Override</span>
                    <span class="kd">public</span> <span class="n">URL</span> <span class="nf">nextElement</span><span class="o">()</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="n">URL</span> <span class="n">url2</span> <span class="o">=</span> <span class="n">url</span><span class="o">;</span>
                        <span class="n">url</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                        <span class="k">return</span> <span class="n">url2</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">};</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kd">super</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * Scans the {@link ClassLoader#getResources(java.lang.String)} for {@literal persistence.xml} files.
         *
         * @return A {@code Collection&lt;URL} of {@literal persistence.xml} URLs.
         * @throws IOException If an exception occurs during processing.
         */</span>
        <span class="kd">public</span> <span class="n">Collection</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="nf">findPersistenceXMLs</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">Enumeration</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">e</span> <span class="o">=</span> <span class="kd">super</span><span class="o">.</span><span class="na">getResources</span><span class="o">(</span><span class="n">PERSISTENCE_XML</span><span class="o">);</span>
            <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * Converts a {@link Document} to a {@code String}.
         *
         * @param document The document to convert.
         * @return A {@code String} representation of the document if the conversion was successful, and {@literal null}
         * otherwise.
         */</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="nf">documentToString</span><span class="o">(</span><span class="kd">final</span> <span class="n">Document</span> <span class="n">document</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">DOMSource</span> <span class="n">source</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DOMSource</span><span class="o">(</span><span class="n">document</span><span class="o">);</span>
                <span class="n">StringWriter</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">();</span>
                <span class="n">StreamResult</span> <span class="n">result</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StreamResult</span><span class="o">(</span><span class="n">writer</span><span class="o">);</span>
                <span class="n">TransformerFactory</span> <span class="n">tf</span> <span class="o">=</span> <span class="n">TransformerFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">();</span>
                <span class="n">Transformer</span> <span class="n">transformer</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="na">newTransformer</span><span class="o">();</span>
                <span class="n">transformer</span><span class="o">.</span><span class="na">transform</span><span class="o">(</span><span class="n">source</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
                <span class="k">return</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">TransformerException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not convert Document to String"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * This method creates the merged {@literal persistence.xml} file from all of {@literal persistence.xml} files found
         * by the {@link ClassLoader} during its scan and constructs a {@link Document} containing the merged
         * {@literal &lt;class&gt;} elements.
         *
         * @return A {@code String} representation of the {@link Document} that was generated.
         */</span>
        <span class="kd">private</span> <span class="n">String</span> <span class="nf">scanPersistenceXML</span><span class="o">()</span>
                <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span>
                <span class="n">ParserConfigurationException</span><span class="o">,</span>
                <span class="n">SAXException</span><span class="o">,</span>
                <span class="n">XPathExpressionException</span><span class="o">,</span>
                <span class="n">TransformerConfigurationException</span><span class="o">,</span>
                <span class="n">TransformerException</span> <span class="o">{</span>
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"scanPersistenceXML()"</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">DocumentBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DOCUMENT_BUILDER_FACTORY</span><span class="o">.</span><span class="na">newDocumentBuilder</span><span class="o">();</span>
            <span class="n">DOCUMENT_BUILDER_FACTORY</span><span class="o">.</span><span class="na">setNamespaceAware</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
            <span class="n">Collection</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">persistenceXMlUrls</span> <span class="o">=</span> <span class="n">findPersistenceXMLs</span><span class="o">();</span>
    
            <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">URL</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">persistenceXMlUrls</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>
            <span class="kd">final</span> <span class="n">URL</span> <span class="n">masterURL</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">it</span><span class="o">.</span><span class="na">remove</span><span class="o">();</span>
    
            <span class="n">LOGGER</span><span class="o">.</span><span class="na">trace</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;&gt; master persistence.xml: %s"</span><span class="o">,</span> <span class="n">masterURL</span><span class="o">));</span>
            <span class="kd">final</span> <span class="n">Document</span> <span class="n">masterDocument</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">masterURL</span><span class="o">.</span><span class="na">toExternalForm</span><span class="o">());</span>
            <span class="kd">final</span> <span class="n">Node</span> <span class="n">puNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">)</span> <span class="n">XPATH_ENTITY_PU_NODE</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODE</span><span class="o">);</span>
            <span class="kd">final</span> <span class="n">Node</span> <span class="n">propertiesNode</span> <span class="o">=</span> <span class="o">(</span><span class="n">Node</span><span class="o">)</span> <span class="n">XPATH_PROPERTIES_NODE</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODE</span><span class="o">);</span>
    
            <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">URL</span> <span class="n">url</span> <span class="o">:</span> <span class="n">persistenceXMlUrls</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;&gt; other persistence.xml: %s"</span><span class="o">,</span> <span class="n">url</span><span class="o">));</span>
                <span class="kd">final</span> <span class="n">Document</span> <span class="n">document</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">url</span><span class="o">.</span><span class="na">toExternalForm</span><span class="o">());</span>
                <span class="kd">final</span> <span class="n">NodeList</span> <span class="n">nodes</span> <span class="o">=</span> <span class="o">(</span><span class="n">NodeList</span><span class="o">)</span> <span class="n">XPATH_ENTITY_CLASS_TEXT</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">document</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
    
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="n">String</span> <span class="n">entityClassName</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">getNodeValue</span><span class="o">();</span>
    
                    <span class="cm">/*
                     * Check for duplicates and only add new classes.
                     */</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">classNodeExists</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">entityClassName</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="s">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; entity class: %s found. Adding to persistence.xml"</span><span class="o">,</span> <span class="n">entityClassName</span><span class="o">));</span>
    
                        <span class="k">if</span> <span class="o">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createComment</span><span class="o">(</span><span class="s">" from "</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="na">toExternalForm</span><span class="o">()</span> <span class="o">+</span> <span class="s">" "</span><span class="o">),</span> <span class="n">propertiesNode</span><span class="o">);</span>
                            <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createTextNode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">),</span> <span class="n">propertiesNode</span><span class="o">);</span>
                        <span class="o">}</span>
                        <span class="kd">final</span> <span class="n">Node</span> <span class="n">child</span> <span class="o">=</span> <span class="n">masterDocument</span><span class="o">.</span><span class="na">createElement</span><span class="o">(</span><span class="s">"class"</span><span class="o">);</span>
                        <span class="n">child</span><span class="o">.</span><span class="na">appendChild</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createTextNode</span><span class="o">(</span><span class="n">entityClassName</span><span class="o">));</span>
                        <span class="c1">// The entity classes must be appended before the properties to successfully validate.</span>
                        <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">propertiesNode</span><span class="o">);</span>
                        <span class="n">puNode</span><span class="o">.</span><span class="na">insertBefore</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">.</span><span class="na">createTextNode</span><span class="o">(</span><span class="s">"\n"</span><span class="o">),</span> <span class="n">propertiesNode</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
    
            <span class="k">return</span> <span class="nf">documentToString</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">);</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * &lt;p&gt;
         * This method will provide a {@link URL} to a virtual file stored in Random Access Memory (RAM) using
         * {@link FileSystemManager}.The method is sufficiently abstract to store any {@code String} data.&lt;/p&gt;
         * &lt;p&gt;
         * The implementation in this class will be used to store our merged persistence.xml files. This way we can avoid
         * storing the merged file on the operating system.&lt;/p&gt;
         *
         * @param data The data to be stored to a virtual file in RAM.
         * @return The {@link URL} to the virtual file in RAM.
         */</span>
        <span class="kd">private</span> <span class="n">URL</span> <span class="nf">getMergedURL</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">FileSystemManager</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">VFS</span><span class="o">.</span><span class="na">getManager</span><span class="o">();</span>
                <span class="c1">// The EntityManagerFactory will scan a pattern like PROJECT_NAME/META-INF/ for persistence.xml file.</span>
                <span class="n">FileObject</span> <span class="n">pxml</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="na">resolveFile</span><span class="o">(</span><span class="s">"ram://RAM_MERGED_PERSISTENCE/META-INF/persistence.xml"</span><span class="o">);</span>
                <span class="n">pxml</span><span class="o">.</span><span class="na">createFile</span><span class="o">();</span>
                <span class="k">try</span> <span class="o">(</span><span class="n">OutputStream</span> <span class="n">os</span> <span class="o">=</span> <span class="n">pxml</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">getOutputStream</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">IOUtils</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">data</span><span class="o">,</span> <span class="n">os</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">));</span>
                <span class="o">}</span>
                <span class="k">try</span> <span class="o">(</span><span class="n">InputStream</span> <span class="n">is</span> <span class="o">=</span> <span class="n">pxml</span><span class="o">.</span><span class="na">getContent</span><span class="o">().</span><span class="na">getInputStream</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">LOGGER</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="n">IOUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">Charset</span><span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">)));</span>
                <span class="o">}</span>
                <span class="k">return</span> <span class="n">pxml</span><span class="o">.</span><span class="na">getURL</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileSystemException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"Could not create RAM filesystem."</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">"An exception occurred while trying to generate merged URL"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    
        <span class="cm">/**
         * This checks the provided master {@literal persistence.xml} {@link Document} for the existence of a class node.
         *
         * @param masterDocument The document to evaluate.
         * @param className The name of class to check to see if it already exists.
         * @return {@literal true} if the class already exists and {@literal false} otherwise.
         */</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">classNodeExists</span><span class="o">(</span><span class="n">Document</span> <span class="n">masterDocument</span><span class="o">,</span> <span class="n">String</span> <span class="n">className</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
            <span class="kd">final</span> <span class="n">NodeList</span> <span class="n">nodeList</span><span class="o">;</span>
    
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">nodeList</span> <span class="o">=</span> <span class="o">(</span><span class="n">NodeList</span><span class="o">)</span> <span class="n">XPATH_ENTITY_CLASS_TEXT</span><span class="o">.</span><span class="na">evaluate</span><span class="o">(</span><span class="n">masterDocument</span><span class="o">,</span> <span class="n">XPathConstants</span><span class="o">.</span><span class="na">NODESET</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">XPathExpressionException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">LOGGER</span><span class="o">.</span><span class="na">warn</span><span class="o">(</span><span class="s">"The provided persistence.xml contains no class entries"</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>
    
            <span class="n">String</span> <span class="n">masterEntityClassName</span><span class="o">;</span>
    
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">getLength</span><span class="o">();</span> <span class="n">j</span><span class="o">++)</span> <span class="o">{</span>
                <span class="n">masterEntityClassName</span> <span class="o">=</span> <span class="n">nodeList</span><span class="o">.</span><span class="na">item</span><span class="o">(</span><span class="n">j</span><span class="o">).</span><span class="na">getNodeValue</span><span class="o">();</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">masterEntityClassName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">className</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
        <span class="o">}</span>
    
    <span class="o">}</span>
</code></pre></div></div>

<p>The implementation is simply a matter of doing a switch on the <code class="highlighter-rouge">ClassLoader</code> as shown below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    
            <span class="n">ClassLoader</span> <span class="n">contextClassLoader</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">getContextClassLoader</span><span class="o">();</span>
            <span class="n">PersistenceClassLoader</span> <span class="n">cl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PersistenceClassLoader</span><span class="o">(</span><span class="n">contextClassLoader</span><span class="o">);</span>
    
            <span class="c1">// We must set the Classloader to use our loader BEFORE calling Persistence.Persistence.createEntityManagerFactory()</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">cl</span><span class="o">);</span>
    
            <span class="n">EntityManagerFactory</span> <span class="n">entityManagerFactory</span> <span class="o">=</span> <span class="n">Persistence</span><span class="o">.</span><span class="na">createEntityManagerFactory</span><span class="o">(</span><span class="s">"example-pu"</span><span class="o">);</span>
    
            <span class="c1">//Reset the classloader</span>
            <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">().</span><span class="na">setContextClassLoader</span><span class="o">(</span><span class="n">contextClassLoader</span><span class="o">);</span>
    
            <span class="n">EntityManager</span> <span class="n">em</span> <span class="o">=</span> <span class="n">entityManagerFactory</span><span class="o">.</span><span class="na">createEntityManager</span><span class="o">();</span>
    
            <span class="o">...</span>
        <span class="o">}</span>
</code></pre></div></div>
<h1 id="conclusion">Conclusion</h1>

<p>The Java Persistence API (JPA) is a great technology, but has some limitations with regards to loading multiple <em>persistence.xml</em> files. We can use <code class="highlighter-rouge">Classloader</code> magic to accomplish loading multiple <em>persistence.xml</em> files.</p>

<p>This code may not work as expected on later versions of Java. At the time of this writing, Java 8 is still used by most of the enterprise clients I work with.</p>


        </section>

        <footer class="post-footer">

            <!-- Everything inside the #author tags pulls data from the author -->
            <!-- #author-->
            
                
                    
                        <figure class="author-image">
                            <a class="img" href="/author/jyeary" style="background-image: url(/assets/images/jyeary.jpg)"><span class="hidden">jyeary's Picture</span></a>
                        </figure>
                    

                    <section class="author">
                        <h4><a href="/author/jyeary">John Yeary</a></h4>

                        
                            <p> Caffeinated Java Programmer, and Principal Software Engineer at Orange Bees.</p>
                        
                        <div class="author-meta">
                            <span class="author-location icon-location"> Greenville, South Carolina, USA</span>
                            <span class="author-link icon-link"><a href="http://jyeary.github.io/"> jyeary.github.io</a></span>
                        </div>
                    </section>

                    <!-- /author  -->

                    <section class="share">
                        <h4>Share this post</h4>
                        <a class="icon-twitter" href="http://twitter.com/share?text=Multiple Java Persistence API (JPA) persistence.xml Merging&amp;url=2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging"
                            onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                            <span class="hidden">Twitter</span>
                        </a>
                        <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging"
                            onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                            <span class="hidden">Facebook</span>
                        </a>
                        <!--
                        <a class="icon-google-plus" href="https://plus.google.com/share?url=2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging"
                           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                            <span class="hidden">Google+</span>
                        </a>
                        -->
                    </section>
                
            

            <!-- Add Disqus Comments -->
            
                <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-wordpress-bluelotus-rhcloud-comtrue'; // required: replace example with your forum shortname
    var disqus_identifier = '/2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging';
    var disqus_url = '/2019-10-15-multiple-java-persistence-api-jpa-persistence-xml-merging';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
        Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
            

        </footer>

    </article>

</main>

<aside class="read-next">

    <!-- [[! next_post ]] -->
    
        <a class="read-next-story " style="background-image: url(/assets/images/bank-cash-cent-164552.jpg)" href="/2019-11-01-blog-migration">
            <section class="post">
                <h2>Blog Migration</h2>
                <p>## Introduction After a couple of years using Wordpress, I have found that constantly upgrading,...</p>
            </section>
        </a>
    
    <!-- [[! /next_post ]] -->
    <!-- [[! prev_post ]] -->
    
        <a class="read-next-story prev " style="background-image: url(/assets/images/bird-birds-black-and-white-681447.jpg)" href="/2019-03-27-js-equality-table">
            <section class="post">
                <h2>JS Equality Table</h2>
                <p>It seems I am always looking for the difference between == and ===. I was...</p>
            </section>
        </a>
    
    <!-- [[! /prev_post ]] -->
</aside>

<!-- /post -->


        <!-- The tiny footer at the very bottom -->
        <footer class="site-footer clearfix">
          <section class="copyright"><a href="/">John Yeary</a> &copy; 2019</section>
          <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> using <a href="https://github.com/jekyller/jasper">Jasper</a></section>
        </footer>
    </div>
    <!-- highlight.js -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- jQuery needs to come before `` so that jQuery can be used in code injection -->
    <script type="text/javascript" src="//code.jquery.com/jquery-1.12.0.min.js"></script>
    <!-- Ghost outputs important scripts and data with this tag -->
    <!--  -->
    <!-- Add Google Analytics  -->
        <!-- Google Analytics Tracking code -->
     <script>
	    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

	    ga('create', 'UA-4194623-5', 'auto');
	    ga('send', 'pageview');

     </script>
    <!-- Fitvids makes video embeds responsive and awesome -->
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <!-- The main JavaScript file for Casper -->
    <script type="text/javascript" src="/assets/js/index.js"></script>

</body>
</html>
